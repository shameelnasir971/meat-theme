{%- style -%}
  .section-{{ section.id }} {
    --primary-red: {{ section.settings.accent_color }};
    --card-bg: {{ section.settings.card_bg_color }};
    --text-dark: {{ section.settings.text_color_heading }};
    --text-muted: {{ section.settings.text_color_sub }};
    background-color: {{ section.settings.bg_color }};
    padding: 60px 0 80px;
    font-family: 'Inter', sans-serif;
    overflow: hidden;
  }

  .container-testimonial {
    max-width: 1240px;
    margin: 0 auto;
    padding: 0 20px;
  }

  .testimonial-header { 
    text-align: center;
    margin-bottom: 40px; 
  }

  .testimonial-title {
    font-family: 'Oswald', sans-serif;
    font-size: clamp(28px, 4vw, 40px);
    font-weight: 700;
    color: var(--text-dark);
    margin-bottom: 12px;
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  .testimonial-subtitle {
    font-size: 16px;
    color: var(--text-muted);
    line-height: 1.5;
    max-width: 500px;
    margin: 0 auto;
  }

  .testimonial-slider-outer {
    position: relative;
    margin: 0 -10px;
    min-height: 250px; 
  }

  .testimonial-slider-wrapper {
    overflow: hidden;
    cursor: grab;
    padding: 10px 0;
  }

  .testimonial-track {
    display: flex;
    transition: transform 0.5s ease-out;
    will-change: transform;
  }

  .testimonial-card {
    flex: 0 0 33.333%;
    padding: 0 10px;
    box-sizing: border-box;
    display: flex;
  }

  .card-inner {
    background-color: var(--card-bg);
    padding: 35px 25px;
    border-radius: 15px;
    text-align: left;
    width: 100%;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    box-shadow: 0 4px 15px rgba(0,0,0,0.03);
  }

  .quote-text {
    font-size: 15px;
    line-height: 1.7;
    color: #333;
    margin-bottom: 25px;
    font-style: italic;
  }

  .author-box { 
    display: flex; 
    align-items: center; 
    gap: 12px; 
  }

  .avatar {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    object-fit: cover;
    background: #eee;
  }

  .author-info h4 {
    font-size: 16px;
    font-weight: 700;
    color: var(--primary-red);
    margin: 0;
  }

  .author-info p {
    font-size: 13px;
    color: #777;
    margin: 0;
  }

  .slider-dots {
    display: flex;
    justify-content: center;
    gap: 8px;
    margin: 25px 0;
    min-height: 10px;
  }

  .dot {
    width: 8px;
    height: 8px;
    background-color: #ddd;
    border-radius: 50%;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .dot.active { 
    background-color: var(--primary-red); 
    width: 20px; 
    border-radius: 10px; 
  }

  .slider-nav {
    display: flex;
    justify-content: center;
    gap: 15px;
  }

  .nav-btn {
    width: 45px;
    height: 45px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: transparent;
    border: 2px solid var(--primary-red);
    color: var(--primary-red);
    transition: 0.3s ease;
  }

  .nav-btn:hover {
    background-color: var(--primary-red);
    color: #fff;
  }

  .nav-btn svg { width: 20px; height: 20px; }

  @media (max-width: 1024px) {
    .testimonial-card { flex: 0 0 50%; }
  }

  @media (max-width: 767px) {
    .testimonial-card { flex: 0 0 100%; }
    .section-{{ section.id }} { padding: 40px 0; }
  }
{%- endstyle -%}

<section class="section-{{ section.id }} testimonial-section-root" data-section-id="{{ section.id }}">
  <div class="container-testimonial">
    
    <div class="testimonial-header">
      <h2 class="testimonial-title">{{ section.settings.heading }}</h2>
      <div class="testimonial-subtitle">{{ section.settings.subheading }}</div>
    </div>

    <div class="testimonial-slider-outer">
      <div class="testimonial-slider-wrapper" id="sliderWrapper-{{ section.id }}">
        <div class="testimonial-track" id="testimonialTrack-{{ section.id }}">
          
          {%- if section.blocks.size > 0 -%}
            {%- for block in section.blocks -%}
              <div class="testimonial-card" {{ block.shopify_attributes }}>
                <div class="card-inner">
                  <p class="quote-text">"{{ block.settings.quote }}"</p>
                  <div class="author-box">
                    {%- if block.settings.image != blank -%}
                      <img 
                        src="{{ block.settings.image | image_url: width: 100, height: 100 }}" 
                        alt="{{ block.settings.name }}" 
                        class="avatar" 
                        width="48" 
                        height="48" 
                        loading="lazy"
                      >
                    {%- else -%}
                      <img 
                        src="https://i.pravatar.cc/100?u={{ forloop.index }}" 
                        alt="User" 
                        class="avatar" 
                        width="48" 
                        height="48" 
                        loading="lazy"
                      >
                    {%- endif -%}
                    <div class="author-info">
                      <h4>{{ block.settings.name }}</h4>
                      <p>{{ block.settings.location }}</p>
                    </div>
                  </div>
                </div>
              </div>
            {%- endfor -%}
          {%- else -%}
            {%- for i in (1..3) -%}
              <div class="testimonial-card">
                <div class="card-inner">
                  <p class="quote-text">"Please add testimonials from your Shopify theme editor to see them here. This is a placeholder text."</p>
                  <div class="author-box">
                    <img 
                      src="https://i.pravatar.cc/100?u={{ i }}" 
                      alt="Placeholder User" 
                      class="avatar" 
                      width="48" 
                      height="48" 
                      loading="lazy"
                    >
                    <div class="author-info"><h4>John Doe</h4><p>Location</p></div>
                  </div>
                </div>
              </div>
            {%- endfor -%}
          {%- endif -%}

        </div>
      </div>
    </div>

    <div class="slider-dots" id="sliderDots-{{ section.id }}"></div>

    <div class="slider-nav">
      <button class="nav-btn prev" onclick="window.slider_{{ section.id | replace: '-', '_' }}.move(-1)">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
      </button>
      <button class="nav-btn next" onclick="window.slider_{{ section.id | replace: '-', '_' }}.move(1)">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18l6-6-6-6"/></svg>
      </button>
    </div>

  </div>
</section>

<script>
class TestimonialSlider {
  constructor(sectionId) {
    this.sectionId = sectionId;
    this.container = document.getElementById(`testimonialTrack-${sectionId}`);
    this.dotsContainer = document.getElementById(`sliderDots-${sectionId}`);
    this.currentIndex = 0;
    this.init();
  }

  init() {
    if (!this.container) return;
    this.setupDots();
    this.update();
    window.addEventListener('resize', () => { this.currentIndex = 0; this.setupDots(); this.update(); });
  }

  getVisibleCards() {
    if (window.innerWidth <= 767) return 1;
    if (window.innerWidth <= 1024) return 2;
    return 3;
  }

  setupDots() {
    if (!this.dotsContainer) return;
    const cards = this.container.querySelectorAll('.testimonial-card');
    const visible = this.getVisibleCards();
    const dotCount = Math.max(0, cards.length - visible + 1);
    
    this.dotsContainer.innerHTML = '';
    for (let i = 0; i < dotCount; i++) {
      const dot = document.createElement('span');
      dot.className = `dot ${i === this.currentIndex ? 'active' : ''}`;
      dot.onclick = () => { this.currentIndex = i; this.update(); };
      this.dotsContainer.appendChild(dot);
    }
  }

  move(dir) {
    const cards = this.container.querySelectorAll('.testimonial-card');
    const visible = this.getVisibleCards();
    const max = Math.max(0, cards.length - visible);
    this.currentIndex += dir;
    if (this.currentIndex < 0) this.currentIndex = max;
    else if (this.currentIndex > max) this.currentIndex = 0;
    this.update();
  }

  update() {
    const cards = this.container.querySelectorAll('.testimonial-card');
    if (cards.length === 0) return;
    const width = cards[0].offsetWidth;
    this.container.style.transform = `translateX(-${this.currentIndex * width}px)`;
    
    const dots = this.dotsContainer.querySelectorAll('.dot');
    dots.forEach((dot, i) => dot.classList.toggle('active', i === this.currentIndex));
  }
}

// Initialize Slider
document.addEventListener('DOMContentLoaded', () => {
  window.slider_{{ section.id | replace: '-', '_' }} = new TestimonialSlider('{{ section.id }}');
});

// Shopify 
document.addEventListener('shopify:section:load', (e) => {
  if (e.detail.sectionId === '{{ section.id }}') {
    window.slider_{{ section.id | replace: '-', '_' }} = new TestimonialSlider('{{ section.id }}');
  }
});
</script>

{% schema %}
{
  "name": "Testimonials Slider",
  "settings": [
    { "type": "text", "id": "heading", "label": "Heading", "default": "What Our Customer Say" },
    { "type": "richtext", "id": "subheading", "label": "Sub-heading", "default": "<p>Every cut of meat is carefully selected, hygienically processed.</p>" },
    { "type": "header", "content": "Colors" },
    { "type": "color", "id": "bg_color", "label": "Section Background", "default": "#ffffff" },
    { "type": "color", "id": "card_bg_color", "label": "Card Background", "default": "#fdf0f0" },
    { "type": "color", "id": "accent_color", "label": "Accent Color (Red)", "default": "#d32f2f" },
    { "type": "color", "id": "text_color_heading", "label": "Heading Text Color", "default": "#1a1a1a" },
    { "type": "color", "id": "text_color_sub", "label": "Sub-heading Text Color", "default": "#555555" }
  ],
  "blocks": [
    {
      "type": "testimonial",
      "name": "Testimonial",
      "settings": [
        { "type": "textarea", "id": "quote", "label": "Quote", "default": "A visual guide could be a wireframe, creative composition, or information architecture." },
        { "type": "image_picker", "id": "image", "label": "Author Image" },
        { "type": "text", "id": "name", "label": "Author Name", "default": "John Carter" },
        { "type": "text", "id": "location", "label": "Location", "default": "Pakistan" }
      ]
    }
  ],
  "presets": [
    {
      "name": "Testimonials Slider",
      "blocks": [
        { "type": "testimonial" },
        { "type": "testimonial" },
        { "type": "testimonial" }
      ]
    }
  ]
}
{% endschema %}