{%- style -%}
.menu-board-{{ section.id }} {
  padding: {{ section.settings.padding_top }}px 0 {{ section.settings.padding_bottom }}px;
  background-color: {{ section.settings.bg_color }};
  font-family: 'Inter', sans-serif;
  color: #ffffff;
}

.mb-container {
  max-width: {{ section.settings.container_width }}px;
  margin: 0 auto;
  padding: 0 20px;
}

.mb-header h2 {
  text-align: center;
  font-size: {{ section.settings.title_size }}px;
  font-weight: 800;
  color: {{ section.settings.title_color }};
  margin-bottom: 40px;
  text-transform: uppercase;
  letter-spacing: 1px;
}

/* Tabs Styling */
.mb-tabs {
  display: flex;
  justify-content: center;
  gap: 12px;
  margin-bottom: 50px;
  flex-wrap: wrap;
}

.mb-tab-btn {
  padding: 10px 30px;
  border: 1px solid #444;
  background: transparent;
  color: #ffffff;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 500;
  transition: all 0.3s ease;
  font-size: 14px;
}

.mb-tab-btn.active {
  background-color: {{ section.settings.accent_color }};
  border-color: {{ section.settings.accent_color }};
}

/* Grid Layout */
.mb-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 25px;
}

/* Card Styling */
.mb-card {
  background-color: {{ section.settings.card_bg }};
  border-radius: 12px;
  display: flex;
  padding: 20px;
  gap: 20px;
  align-items: center;
  border: 1px solid rgba(255,255,255,0.05);
  transition: transform 0.3s ease;
  cursor: pointer; /* Added cursor pointer to show it is clickable */
}

.mb-card:hover {
  transform: translateY(-5px);
}

.mb-img-box {
  flex: 0 0 45%;
  aspect-ratio: 1.2 / 1;
  border-radius: 8px;
  overflow: hidden;
}

.mb-img-box img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.mb-content {
  flex: 1;
}

.mb-content h3 {
  margin: 0 0 8px;
  font-size: 24px;
  font-weight: 700;
  color: #ffffff;
}

.mb-desc {
  font-size: 13px;
  color: #b0b0b0;
  line-height: 1.5;
  margin-bottom: 12px;
  display: -webkit-box;
  -webkit-line-clamp: 3;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.mb-price {
  font-size: 18px;
  font-weight: 600;
  color: #ffffff;
  margin-bottom: 15px;
}

.mb-add-btn {
  background-color: {{ section.settings.accent_color }};
  color: #ffffff;
  border: none;
  padding: 12px 25px;
  border-radius: 6px;
  font-size: 13px;
  font-weight: 700;
  cursor: pointer;
  text-transform: capitalize;
  display: inline-block;
  text-decoration: none;
  width: fit-content;
}
/* Loading State */
.mb-add-btn.loading { opacity: 0.7; pointer-events: none; }

/* Responsive */
@media (max-width: 991px) {
  .mb-grid { grid-template-columns: 1fr; }
}

@media (max-width: 600px) {
  .mb-card { flex-direction: column; text-align: center; }
  .mb-img-box { width: 100%; flex: none; }
  .mb-add-btn { width: 100%; }
}
{%- endstyle -%}

<section class="menu-board-{{ section.id }}">
  <div class="mb-container">
    <div class="mb-header">
      <h2>{{ section.settings.heading }}</h2>
    </div>

    <!-- Tabs Area -->
    <div class="mb-tabs">
      <button class="mb-tab-btn active" onclick="filterMenu('all', this, '{{ section.id }}')">All</button>
      {%- if section.blocks.size > 0 -%}
        {%- for block in section.blocks -%}
          <button class="mb-tab-btn" onclick="filterMenu('cat-{{ block.id }}', this, '{{ section.id }}')">
            {{ block.settings.tab_title | default: block.settings.collection.title }}
          </button>
        {%- endfor -%}
      {%- else -%}
        <button class="mb-tab-btn">Steak</button>
        <button class="mb-tab-btn">Duck</button>
        <button class="mb-tab-btn">Beef</button>
        <button class="mb-tab-btn">Goat</button>
      {%- endif -%}
    </div>

    <!-- Product Grid Area -->
    <div class="mb-grid" id="grid-{{ section.id }}">
      {%- if section.blocks.size > 0 -%}
        {%- for block in section.blocks -%}
          {%- assign collection = collections[block.settings.collection] -%}
          {%- for product in collection.products limit: 6 -%}
            <!-- 
               CLICKABLE CARD LOGIC:
               Card click -> Redirects to product page.
            -->
            <div class="mb-card cat-{{ block.id }} all-items" onclick="window.location.href='{{ product.url }}'">
              <div class="mb-img-box">
                <img 
                  src="{{ product.featured_image | image_url: width: 600 }}" 
                  alt="{{ product.title | escape }}" 
                  width="600" 
                  height="500" 
                  loading="lazy"
                >
              </div>
              <div class="mb-content">
                <h3>{{ product.title }}</h3>
                <p class="mb-desc">{{ product.description | strip_html | truncate: 120 }}</p>
                <div class="mb-price">From: {{ product.price | money }}</div>
                
                <!-- 
                   AJAX ADD TO CART:
                   onclick="event.stopPropagation()" prevents card click redirect.
                   onsubmit="addToCartMenuAjax..." handles the API call.
                -->
                <form method="post" action="/cart/add" onclick="event.stopPropagation()" onsubmit="addToCartMenuAjax(event, this)">
                  <input type="hidden" name="id" value="{{ product.variants.first.id }}" />
                  <button type="submit" class="mb-add-btn">Add To Cart</button>
                </form>
              </div>
            </div>
          {%- endfor -%}
        {%- endfor -%}
      {%- else -%}
        {%- assign titles = "Beef Chops,Beef Steak,Duck Roast,Wild Boar" | split: "," -%}
        {%- assign img_urls = "https://images.unsplash.com/photo-1603048297172-c92544798d5e?q=80&w=800,https://images.unsplash.com/photo-1546241072-48010ad2862c?q=80&w=800,https://images.unsplash.com/photo-1518492104633-c3ed9e78117a?q=80&w=800,https://images.unsplash.com/photo-1558030006-450675393462?q=80&w=800" | split: "," -%}
        
        {%- for i in (0..3) -%}
          <div class="mb-card all-items">
            <div class="mb-img-box">
              <img 
                src="{{ img_urls[i] }}" 
                alt="Placeholder Meat" 
                width="600" 
                height="500" 
                loading="lazy"
              >
            </div>
            <div class="mb-content">
              <h3>{{ titles[i] }}</h3>
              <p class="mb-desc">Fresh halal beef chops, thick cut, perfect for BBQ, average weight 500g.</p>
              <div class="mb-price">From: $24.00</div>
              <button class="mb-add-btn">Add To Cart</button>
            </div>
          </div>
        {%- endfor -%}
      {%- endif -%}
    </div>
  </div>
</section>

<script>
// Filter Tabs Logic
function filterMenu(catId, btn, sectionId) {
  const section = btn.closest('section');
  section.querySelectorAll('.mb-tab-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');

  const cards = section.querySelectorAll('.all-items');
  cards.forEach(card => {
    if (catId === 'all' || card.classList.contains(catId)) {
      card.style.display = 'flex';
    } else {
      card.style.display = 'none';
    }
  });
}

// AJAX Add To Cart Logic
function addToCartMenuAjax(e, form) {
  e.preventDefault(); // Stop Page Redirect
  e.stopPropagation(); // Stop bubbling

  const btn = form.querySelector('button');
  const originalText = btn.innerText;
  
  btn.innerText = "Adding...";
  btn.classList.add('loading');

  const formData = new FormData(form);

  // 1. Add item to cart
  fetch('/cart/add.js', {
    method: 'POST',
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    // 2. Fetch updated cart count
    return fetch('/cart.js');
  })
  .then(res => res.json())
  .then(cart => {
    // 3. Update Header Cart Count (Find elements with class .cart-count-pro)
    const countBadges = document.querySelectorAll('.cart-count-pro');
    countBadges.forEach(badge => {
      badge.innerText = cart.item_count;
      badge.style.display = cart.item_count > 0 ? 'flex' : 'none';
    });

    // Reset Button
    btn.innerText = "Added!";
    setTimeout(() => {
      btn.innerText = originalText;
      btn.classList.remove('loading');
    }, 2000);
  })
  .catch(err => {
    console.error('Error adding to cart:', err);
    btn.innerText = "Error";
    setTimeout(() => {
        btn.innerText = originalText;
        btn.classList.remove('loading');
    }, 2000);
  });
}
</script>

{% schema %}
{
  "name": "Butcher Menu Board",
  "settings": [
    { "type": "text", "id": "heading", "label": "Section Heading", "default": "Menu Board" },
    { "type": "range", "id": "title_size", "label": "Heading Size", "min": 20, "max": 70, "step": 1, "default": 45 },
    { "type": "header", "content": "Colors" },
    { "type": "color", "id": "bg_color", "label": "Background", "default": "#111111" },
    { "type": "color", "id": "card_bg", "label": "Card Background", "default": "#1a1a1a" },
    { "type": "color", "id": "accent_color", "label": "Accent Color", "default": "#d32f2f" },
    { "type": "color", "id": "title_color", "label": "Title Color", "default": "#ffffff" },
    { "type": "header", "content": "Layout Settings" },
    { "type": "range", "id": "container_width", "label": "Max Width", "min": 1000, "max": 1600, "step": 10, "default": 1200 },
    { "type": "range", "id": "padding_top", "label": "Padding Top", "min": 0, "max": 100, "step": 5, "default": 60 },
    { "type": "range", "id": "padding_bottom", "label": "Padding Bottom", "min": 0, "max": 100, "step": 5, "default": 60 }
  ],
  "blocks": [
    {
      "type": "collection_group",
      "name": "Category Tab",
      "settings": [
        { "type": "text", "id": "tab_title", "label": "Tab Label (Optional)" },
        { "type": "collection", "id": "collection", "label": "Select Collection" }
      ]
    }
  ],
  "presets": [
    {
      "name": "Butcher Menu Board"
    }
  ]
}
{% endschema %}